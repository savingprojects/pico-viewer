<script type="text/javascript" src="../diya-sdk/dist/diya-sdk.js"></script>
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../display-pdf/display-pdf.html">

<polymer-element name="pico-viewer" attributes="selector httpServer">
	<template>

		<style>
			:host{
				display: flex;
				flex-direction: column;
				align-items: center;
				/*flex-wrap: wrap;*/
				max-height: 100%;
				max-width: 100%;
				}

			#display{
				display: flex;
				flex-direction: column;
				align-items: center;
				height: 100%;
				width: 100%;
			}

			#videoBloc{
				height: 100%;
				width: 100%;
			}
			#imageBloc{
				margin: 0px;
				height: 100%;
				width: 100%;
			}
			#pdfBloc{
				/*margin: 0px;*/
				height: 100%;
				width: 100%;
				/*display: flex;*/
				/*justify-content: center;*/
				/*align-items: center;*/
			}

			paper-button{
				color: white;
			}

			.evenPage{
				display: flex;
				height: 80%;
				width: 70%;
			}

			.oddPage{
				display: block;
				height: 80%;
				width: 70%;
			}

		</style>

		<div id="display">
			<template if="{{img}}">
				<figure id="imageBloc" >
					<img width="100%" height="100%"src="{{imageSrc}}"/>
				</figure>
			</template>
			<template if="{{vd}}">
				<div id="videoBloc">
					<video id="vid" controls loop width="100%" height= "100%">
						<source src="{{videoSrc}}" type="video/mp4">
					</video>
				</div>
			</template>
			<template if="{{pdf}}" selector="{{selector}}">
				<figure id="pdfBloc" >
					<template if="{{mobile}}">
						<display-pdf width="100%" height="100%" source="{{pdfSrc}}"></display-pdf>
					</template>
					<template if="{{!mobile}}">
						<paper-button on-tap="{{prev}}">prev</paper-button>
						<paper-button on-tap="{{next}}">next</paper-button>
						<embed class="{{page%2===0? 'evenPage':'oddPage'}}" width="100%" height="100%" src="{{dispPage}}"></embed>
					</template>
				</figure>
			</template>
		</div>
	</template>
	<script>

		Polymer({
			ready: function(){

				var that = this;
				this.status = '';
				this.files = [];
				this.imageSrc = '';
				this.videoSrc = '';
				this.pdfSrc = '';
				this.img = false;
				this.vd = false;
				this.pdf = false;
				this.page = 1;
				this.nbPage = 14;
				// this.dispPage = "#page=" + JSON.stringify(this.page);
				this.mobile = this.isMobile();


				// this.other;
				// this.$.vid;

				//connexion

			},

			isMobile:function ()
			{
				console.log("Mobile:");
				console.log(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
				return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
		    },

			selectorChanged: function(){
				if(this.selector){

					console.log(this.selector);
				}


				this.listenViewers();
				// this.stop();
			},

			setImage: function(file){
				this.httpServer = 'http://localhost:9001/pdf.js/www/';
				this.imageSrc = this.httpServer + file;
			},

			setVideo: function(file){
				var that = this;
				this.httpServer = 'http://localhost:9001/pdf.js/www/';

				this.videoSrc = this.httpServer + file;
				console.log("setVideo");

				setTimeout(function(){

					console.log(that.$);
					video = that.shadowRoot.querySelector('#vid');

					if(!video) return ;

					video.load();
					video.play();

				}, 500);
			},

			setPdf: function(file){
				// var file = 'compressed.tracemonkey-pldi-09.pdf';
				this.httpServer = '/pdf.js/www/';
				this.pdfSrc = this.httpServer + file ;
				console.log(this.pdfSrc);
			},

			listenViewers: function(){
				var that = this;

				d1(this.selector).listenViewers(function(peerId, err, data){
					console.log(data);
					console.log(peerId);
					console.log(err);
					var extension = data.file.split(".").pop();
					extension = extension.toLowerCase();
					switch (extension){
						case "img":
						case "jpg":
						case "png":
						case "jpeg":
							that.setImage(data.file);
							that.img = true;
							that.vd = false;
							that.pdf = false;
							console.log("Image"); break;

						case "mp4":
						case "avi":
						case "mov":
						case "webm":
							that.setVideo(data.file);
							that.vd = true;
							that.img = false;
							that.pdf = false;
							console.log("Video"); break;

						case "pdf":
							that.setPdf(data.file);
							// that.setPdf();
							that.pdf = true;
							that.img = false;
							that.vd = false;
							that.page = 1;
							that.goOnPage(that.page); //if not using library pdf.js
						 	console.log("Pdf"); break;

						//case "html": console.log("Page web"); break;


						default: console.log("...."); other = true; break;
					}

					that.status = data.file;

					console.log("data: " + data.file);
					console.log("ext: " + extension);
					console.log("_________________________");
				});
			},

			next: function(){
				if(this.page < this.nbPage){
					this.page+=1;
					this.goOnPage(this.page);
					// this.setPdf(this.dispPage);
					// this.pdfSrc = this.dispPage;
				}
			},

			prev: function(){
				if(this.page > 1){
					this.page-=1;
					this.goOnPage(this.page);
				}
			},

			goOnPage: function(p){
				// this.listenViewers();
				this.dispPage = this.pdfSrc + "#page=" + p;
				console.log(this.dispPage);
			},


			// stop: function(){
			// 	d1(this.selector).stop(function(peerId, err, data){
			// 		that.vd = false;
			// 		that.img = true;
			// 		console.log("________");
			// 		that.setImage(data.file);
			// 		console.log("_________");
			// 	});
			// },
		});

	</script>
</polymer-element>
